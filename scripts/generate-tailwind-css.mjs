#!/usr/bin/env node
import { compile } from 'tailwindcss';
import { __unstable__loadDesignSystem } from 'tailwindcss';
import path from 'node:path';
import fs from 'node:fs/promises';
import { createRequire } from 'node:module';
import { pathToFileURL } from 'node:url';

const require = createRequire(import.meta.url);
const projectDir = process.cwd();
const tailwindConfigPath = path.join(projectDir, 'tailwind.config.js');
const outputFile = path.join(projectDir, 'src/app/tailwind.generated.css');

async function loadModule(id, base, resourceHint) {
  const resolved = require.resolve(id, { paths: [base] });
  const imported = await import(pathToFileURL(resolved).href);
  return {
    path: resolved,
    base: path.dirname(resolved),
    module: imported.default ?? imported,
  };
}

async function gatherSourceFiles(rootDir) {
  const result = [];
  async function walk(current) {
    const entries = await fs.readdir(current, { withFileTypes: true });
    for (const entry of entries) {
      if (entry.name.startsWith('.')) continue;
      const fullPath = path.join(current, entry.name);
      if (entry.isDirectory()) {
        await walk(fullPath);
        continue;
      }
      const ext = path.extname(entry.name);
      if (!['.ts', '.tsx', '.js', '.jsx', '.mdx'].includes(ext)) continue;
      result.push(fullPath);
    }
  }
  await walk(rootDir);
  return result;
}

const TOKEN_REGEX = /[!A-Za-z0-9\-:\/\[\]\.%=_]+/g;

async function extractCandidates(files, designSystem) {
  const candidates = new Set();
  for (const file of files) {
    const content = await fs.readFile(file, 'utf8');
    const matches = content.match(TOKEN_REGEX);
    if (!matches) continue;
    for (const token of matches) {
      const parsed = designSystem.parseCandidate(token);
      if (parsed.length > 0) {
        candidates.add(token);
      }
    }
  }
  return Array.from(candidates);
}

async function generate() {
  const sourceCss = '@config "./tailwind.config.js";@tailwind base;@tailwind components;@tailwind utilities;';
  const options = { base: projectDir, loadModule };
  const designSystem = await __unstable__loadDesignSystem(sourceCss, options);
  const files = await gatherSourceFiles(path.join(projectDir, 'src'));
  const candidates = await extractCandidates(files, designSystem);
  const { build } = await compile(sourceCss, options);
  const utilitiesCss = build(candidates);
  const preflightPath = require.resolve('tailwindcss/preflight.css');
  const preflightCss = await fs.readFile(preflightPath, 'utf8');
  const content = `/*! Generated by scripts/generate-tailwind-css.mjs */\n${preflightCss}\n${utilitiesCss}`;
  await fs.writeFile(outputFile, content, 'utf8');
}

await generate();
