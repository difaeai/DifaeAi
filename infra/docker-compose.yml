version: '3.8'

services:
  media:
    image: alfg/nginx-rtmp
    container_name: media
    ports:
      - "1935:1935"
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - media-hls:/tmp/hls

  janus:
    image: meetecho/janus-gateway
    container_name: janus
    network_mode: "host"
    environment:
      - JANUS_LOG_LEVEL=4
      - JANUS_PLUGIN_DIR=/usr/local/lib/janus/plugins
    volumes:
      - ../media/janus:/usr/local/etc/janus:ro

  bridge-api:
    build: ../bridge-api
    container_name: bridge-api
    depends_on:
      - media
      - janus
      - ingest-worker
    env_file:
      - ./.env
    volumes:
      - ../bridge-api/openapi.yaml:/app/openapi.yaml:ro
      - ./keys/dev.key:/run/bridge/jwt.key:ro
      - ./keys/dev.pub:/run/bridge/jwt.pub:ro
    environment:
      - JWT_PRIVATE_KEY_PATH=/run/bridge/jwt.key
      - JWT_PUBLIC_KEY_PATH=/run/bridge/jwt.pub

  ingest-worker:
    build: ../ingest-worker
    container_name: ingest-worker
    env_file:
      - ./.env
    depends_on:
      - media

  web-demo:
    image: nginx:alpine
    container_name: web-demo
    depends_on:
      - bridge-api
    volumes:
      - ../web-demo:/usr/share/nginx/html:ro
    ports:
      - "5173:80"

volumes:
  media-hls:
